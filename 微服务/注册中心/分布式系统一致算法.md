# 分布式系统一致性算法

* 解决我们系统集群后每个节点能够保存数据的一致性：raft（nacos），zab（zookeeper），paxos等。



## ZAP

* Zookeeper基于ZAP协议实现保持每个节点的数据同步的问题，中心化思想集群模式；

  分为领导和跟随者角色。
  
* ZAP的协议实现原理是通过比较myId，myId谁最大谁就是可能为领导角色，只要满足过半的机制就可以成为领导角色，后来启动的节点不会参与选举的。
  
* 如何保证数据的一致性的问题：所有的写的请求统一交给我们的领导角色实现，领导角色写完数据之后，领导角色再将数据同步给每个节点。注意：数据之间同步采用2pc两阶段提交协议。
  
  
  



### Raft

* 选举过程

  * 默认的情况下每个节点都是跟随者
  * 每个节点会随机的生成一个选举的超时时间，大概是100-300ms，在这个超时时间的范围内必须要进行等待。
  * 超时时间过后，当前的节点状态可能由追随者变为竞选者状态，会给其他的系欸但发出选举的投票通知，只要该竞选者有超过半数以上即可选为领导角色。

  注意：谁的超时时间最短，谁就最有可能成为领导角色。

  * 如果存在随机的超时时间相同的情况
    * 如果所有的节点的超时随机数都是一样的情况下，当前的投票全部作废，重新进入随机生成超时时间。
    * 如果多个的节点的超时随机数都是一样的情况下，比较谁的票数最多，谁就是领导者，如果票数完全一样的情况下，直接作废，重新进入随机生成超时时间。

* 故障重新实现选举

  * 如果我们跟随者节点不能及时的收到领导角色的消息，那么这时候跟随者状态就会变为竞选者状态，发给其他的节点发出选举投票通知，只要该竞选者有超过半数以上即可选举为领导角色。

* 数据保持一致

  * 所有的写的请求都是统一交给我们的领导角色完成，会写入该对应的日志，标记该状态是未提交状态。
  * 为了提交该日志，领导角色就会将该日志心跳的形式发送其他的跟随者，只要满足过半的跟随者可以写入该数据，则为直接通知其他节点同步该数据，该过程称为日志复制。